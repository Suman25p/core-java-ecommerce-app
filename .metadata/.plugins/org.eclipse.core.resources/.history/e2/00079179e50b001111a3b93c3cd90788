package com.ecommerce.service;

import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import com.ecommerce.exception.OutOfStockException;
import com.ecommerce.model.Product;

public class CartManagement {
	
	private Map<Product, Integer> cart = new HashMap<>();
	
	public void addToCart(Product product, int quantity) throws OutOfStockException {
		if(product.getStock() < quantity) {
			throw new OutOfStockException("Stock not available");
		}
		
		if(cart.containsKey(product)) {
			int existingQty = cart.get(product);
			cart.put(product, existingQty + quantity);
		} else {
			cart.put(product, quantity);
		}
	}
	
	public Map<Product, Integer> getCart(){
		return cart;
	}
	
	public void removeFromCart(Product product) 
	{
		cart.remove(product);
	}
	
	public void viewCart() {
		cart.forEach((product, qty) -> {
			double subTotal = product.getPrice() * qty;
			
			System.out.println(product.getName() + " | Qty: " + qty + " | SubTotal: Rs. " + subTotal);
		});
	}
	
	public double calculateTotal() {
		double total = 0;
		
		Iterator<Map.Entry<Product, Integer>> iterator =
				cart.entrySet().iterator();
		
		while(iterator.hasNext()) {
			Map.Entry<Product, Integer> entry = iterator.next();
			
			total = total + entry.getKey().getPrice() * entry.getValue();
		}
		return total;
	}
	
	public void reduceStock()
	{
		//cart.forEach((product,qty) -> product.setStock(product.getStock() - qty));
		cart.forEach((product,qty) -> {
			int currentStock = product.getStock();
			int newStock = currentStock - qty;
			
			product.setStock(newStock);
		});
	}
	
	public void clearCart()
	{
		cart.clear();
	}
	
	public boolean isCartEmpty() {
		return cart.isEmpty();
	}
}
